<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üì∏ Image Metadata Extractor</title>
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/heic2any/dist/heic2any.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      line-height: 1.5;
    }
    h2 {
      color: #333;
    }
    input {
      margin: 10px 0;
    }
    #preview {
      margin-top: 10px;
      max-width: 300px;
      border: 1px solid #ccc;
      display: block;
      border-radius: 6px;
    }
    #output {
      margin-top: 20px;
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ddd;
      max-width: 600px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h2>üì∏ Image Metadata Extractor</h2>

  <input type="file" accept="image/*" id="imageInput" capture="environment" />
  <br />
  <img id="preview" alt="Image preview will appear here" />
  <div id="output">Metadata will appear here...</div>

  <script>
    function convertDMSToDD(dms, ref) {
      if (!dms || dms.length !== 3) return null;
      let dd = dms[0] + dms[1] / 60 + dms[2] / 3600;
      if (ref === "S" || ref === "W") dd *= -1;
      return dd;
    }

    async function handleFile(file) {
      // Clear previous content
      document.getElementById("preview").src = "";
      document.getElementById("output").textContent = "Metadata will appear here...";

      let workingFile = file;

      // Convert HEIC to JPEG if needed
      if (file.type === "image/heic" || file.name.toLowerCase().endsWith(".heic")) {
        try {
          const jpegBlob = await heic2any({ blob: file, toType: "image/jpeg" });
          workingFile = new File([jpegBlob], file.name.replace(/\.heic$/i, ".jpg"), {
            type: "image/jpeg",
          });
        } catch (err) {
          document.getElementById("output").textContent = "‚ö†Ô∏è Failed to convert HEIC to JPEG.";
          return;
        }
      }

      // Show preview
      const reader = new FileReader();
      reader.onload = function (event) {
        const imageSrc = event.target.result + "#" + new Date().getTime();
        document.getElementById("preview").src = imageSrc;
      };
      reader.readAsDataURL(workingFile);

      // Extract EXIF metadata
      EXIF.getData(workingFile, function () {
        const tags = EXIF.getAllTags(this);
        let output = "";

        if (Object.keys(tags).length === 0) {
          document.getElementById("output").textContent = "‚ö†Ô∏è No EXIF metadata found in this image.";
          return;
        }

        if (tags.Make || tags.Model) {
          output += `üì∑ Camera: ${tags.Make || ""} ${tags.Model || ""}\n`;
        }

        if (tags.DateTime) {
          output += `‚è∞ Date Taken: ${tags.DateTime}\n`;
        }

        if (tags.GPSLatitude && tags.GPSLongitude) {
          const lat = convertDMSToDD(tags.GPSLatitude, tags.GPSLatitudeRef);
          const lon = convertDMSToDD(tags.GPSLongitude, tags.GPSLongitudeRef);

          output += `üß≠ Raw GPSLatitude: ${JSON.stringify(tags.GPSLatitude)}\n`;
          output += `üß≠ Raw GPSLongitude: ${JSON.stringify(tags.GPSLongitude)}\n`;
          output += `üß≠ GPSLatitudeRef: ${tags.GPSLatitudeRef}\n`;
          output += `üß≠ GPSLongitudeRef: ${tags.GPSLongitudeRef}\n`;

          if (!isNaN(lat) && !isNaN(lon)) {
            output += `üìç Location: ${lat.toFixed(6)}, ${lon.toFixed(6)}\n`;
            output += `üåç Google Maps: https://maps.google.com/?q=${lat},${lon}\n`;
          } else {
            output += `üìç GPS tags found but incomplete or invalid\n`;
          }
        } else if (tags.GPSLatitude || tags.GPSLongitude) {
          output += `üìç GPS tags found but incomplete or invalid\n`;
        } else {
          output += `üìç Location: Not available in this photo\n`;
        }

        output += "\n--- Full Metadata ---\n";
        output += JSON.stringify(tags, null, 2);

        document.getElementById("output").textContent = output;
      });
    }

    document.getElementById("imageInput").addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (file) handleFile(file);
    });
  </script>
</body>
</html>
